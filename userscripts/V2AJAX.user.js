// ==UserScript==
// @name V2AJAX (Ajax Submit in V2EX)
// @description using ajax to submit in v2ex.
// @version 0.2.5.1
// @auther yyfearth#gmail.com
// @include *://v2ex.com/t/*
// @include *://*.v2ex.com/t/*
// ==/UserScript==
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=[].slice;d=function(a,b){return null==b&&(b=document),b.querySelector(a)},e=function(a,b){return null==b&&(b=document),[].slice.call(b.querySelectorAll(a))},b=function(a,b,c){return a.addEventListener(b,c,!1)},a=function(a){var b,c,d,e,f,g,h,i,j;return j=null!=a?a:{},i=j.xhr,e=j.method,h=j.url,c=j.data,a=j.async,g=j.timeout,b=j.complete,f=j.success,d=j.error,null==i&&(i=new XMLHttpRequest),e=(e||"GET").toUpperCase(),i.open(e,h,null!=a?a:!0),/^post$/i.test(e)&&i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g&&(i.timeout=g),i.onreadystatechange=function(){if(i.readyState===4)return typeof b=="function"&&b(i),i.status===200?typeof f=="function"?f(i.responseText,i):void 0:typeof d=="function"?d(i.status,i.responseText,i):void 0},i.ontimeout=function(){return typeof d=="function"?d(i.status,"timeout",i):void 0},i.send(c),i},c=function(a){var b;return b=document.implementation.createHTMLDocument(document.title),b.documentElement.innerHTML=a,b},i=function(){var a,b;a=arguments[0],b=2<=arguments.length?z.call(arguments,1):[],null==a&&(a=!0),console.error.apply(console,b),"submit"===a?t.submit():"reload"===a?location.reload():console.log("failed",a)},m=function(a){return null==a&&(a=document),(a=e("#Main>.box",a)[1])&&/\u611f\u8c22\u56de\u590d\u8005|\u76ee\u524d\u5c1a\u65e0\u56de\u590d|\d+\s*\u56de\u590d\s*\|\s*\u76f4\u5230/.test(a.textContent)?a:null},l=function(a){return null==a&&(a=document),a=d("#Rightbar>.box",a),d("#money",a)||d('[href="/notifications"]',a)?a:null},k=function(a,b){var c;return null==a&&(a=document),c=d('#Main a[href*="favorite"]',a),c?b?c:c.parentElement:null},s=d("#reply_content");for(t=s.parentElement;"FORM"!==t.tagName;)if(t=t.parentElement,!t)return i("stop","cannot find submit form");u=d('input[type="submit"]'),u.text=u.value,r=m(null);if(!r)return i("stop","cannot find replies box");(n=l(null))||i("continue","cannot find info box"),(j=k(null))||i("continue","cannot find fav bar"),w=t.action+"#content",v=localStorage[w]||"",!s.value&&v&&(s.value=v,console.log("load from store",w,v)),f=function(){var a;a=s.value;if((v=localStorage[w])||a)localStorage[w]=a.trim(),console.log("save to store",w,a)},b(window,"unload",f),y=function(a){var b;(a=a.trim())?(a=c(a),a.title&&document.title!==a.title&&(document.title=a.title),(b=m(a))||i("reload","cannot locate new replies"),r.className=b.className,r.innerHTML=b.innerHTML,s.value="",n&&((b=l(a))?n.innerHTML=b.innerHTML:i("continue","cannot locate new info box")),j&&((a=k(a))?(j.innerHTML=a.innerHTML,g()):i("continue","cannot locate new fav bar"))):(alert("ajax return empty result"),i("reload","empty return html"))},(g=function(){var b,c;(c=k(null,!0))||i("continue","cannot locate new fav bar"),b=c.href,c.href="#fav",c.onclick=function(d){return d.preventDefault(),c.textContent=c.textContent+"...",c.onclick=function(){return!1},a({url:b,method:"GET",success:y,error:function(a,b){return console.error("fav failed",a,b)}}),!1},console.log("fav ajax enabled")})(),o=function(a){return u.classList[a?"remove":"add"]("normal"),u.disabled=!!a},p=function(a){var b,c;return a?(c="...",a="remove",b=!0):(c="",a="add",b=!1),u.value=u.text+c,u.classList[a]("normal"),u.disabled=s.disabled=b},h=function(){var b;console.log("ajax submit"),(b=s.value.trim())?(b="content="+encodeURIComponent(b.replace(/\n/g,"\r\n")),p(!0),a({url:t.action,method:t.method,data:b,timeout:5e3,success:y,error:function(a,b){return i("submit","ajax failed",a,b)},complete:function(){return p(!1)}})):o(!0)},q=function(){if(s.value.trim())return t.submit()},u.type="button",u.onclick=function(a){return a.altKey?q():h()},b(s,"keydown",function(a){if((a.ctrlKey||a.metaKey)&&a.which===13)return a.preventDefault(),a.stopPropagation(),h(),!1}),b(s,"blur",function(){s.value=s.value.trim()}),(x=function(){var a;a=!s.value.trim(),s._not_empty!==a&&o(a)})(),b(s,"input",x),b(s,"change",function(){s.value=s.value.trim(),x(),f()}),b=/Mac OS/i.test(navigator.userAgent)?"^/\u2318 + \u21b5":"ctrl+enter",u.insertAdjacentHTML("afterend",'<span class="fade"> '+b+" </span>")})()
