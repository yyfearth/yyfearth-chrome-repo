// ==UserScript==
// @name V2AJAX (Ajax Submit in V2EX)
// @description using ajax to submit in v2ex.
// @version 0.2.3
// @auther yyfearth#gmail.com
// @include *://*.v2ex.com/t/*
// ==/UserScript==
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=[].slice;c=function(a,b){return null==b&&(b=document),b.querySelector(a)},d=function(a,b){return null==b&&(b=document),[].slice.call(b.querySelectorAll(a))},b=function(a,b,c){return a.addEventListener(b,c,!1)},a=function(a){var b,c,d,e,f,g,h,i,j;return j=null!=a?a:{},i=j.xhr,e=j.method,h=j.url,c=j.data,a=j.async,g=j.timeout,b=j.complete,f=j.success,d=j.error,null==i&&(i=new XMLHttpRequest),null==a&&(a=!0),i.open(e,h,a),/^post$/i.test(e)&&i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g&&(i.timeout=g),i.onreadystatechange=function(){if(i.readyState===4)return typeof b=="function"&&b(i),i.status===200?typeof f=="function"?f(i.responseText,i):void 0:typeof d=="function"?d(i.status,i.responseText,i):void 0},i.ontimeout=function(){return typeof d=="function"?d(i.status,"timeout",i):void 0},i.send(c),i},g=function(){var a,b;a=arguments[0],b=2<=arguments.length?v.call(arguments,1):[],null==a&&(a=!0),console.error.apply(console,b),"submit"===a?p.submit():"reload"===a?location.reload():console.log("failed",a)},i=function(a){return null==a&&(a=document),(a=d("#Main>.box",a)[1])&&/\u611f\u8c22\u56de\u590d\u8005|\u76ee\u524d\u5c1a\u65e0\u56de\u590d|\d+\s*\u56de\u590d\s*\|\s*\u76f4\u5230/.test(a.innerText||a.textContent)?a:null},h=function(a){return null==a&&(a=document),a=c("#Rightbar>.box",a),c("#money",a)||c('[href="/notifications"]',a)?a:null},o=c("#reply_content");for(p=o.parentElement;"FORM"!==p.tagName;)if(p=p.parentElement,!p)return g("stop","cannot find submit form");q=c('input[type="submit"]'),q.text=q.value,n=i(null);if(!n)return g("stop","cannot find replies box");(j=h(null))||g("continue","cannot find info box"),s=p.action+"#content",r=localStorage[s]||"",!o.value&&r&&(o.value=r,console.log("load from store",s,r)),e=function(){var a;a=o.value;if((r=localStorage[s])||a)localStorage[s]=a.trim(),console.log("save to store",s,a)},b(window,"unload",e),k=function(a){return q.classList[a?"remove":"add"]("normal"),q.disabled=!!a},l=function(a){var b,c;return a?(c="...",a="remove",b=!0):(c="",a="add",b=!1),q.value=q.text+c,q.classList[a]("normal"),q.disabled=o.disabled=b},u=function(a){var b;(a=a.trim())||(alert("ajax return empty result"),g("reload","empty return html")),b=document.implementation.createHTMLDocument(document.title),b.documentElement.innerHTML=a,b.title&&document.title!==b.title&&(document.title=b.title),(a=i(b))||g("reload","cannot locate new replies"),n.className=a.className,n.innerHTML=a.innerHTML,o.value="",o.focus(),j&&((b=h(b))?j.innerHTML=b.innerHTML:g("continue","cannot locate new info box"))},f=function(){var b;console.log("ajax submit"),(b=o.value.trim())?(b="content="+encodeURIComponent(b.replace(/\n/g,"\r\n")),l(!0),a({url:p.action,method:p.method,data:b,timeout:5e3,success:u,error:function(a,b){return g("submit","ajax failed",a,b)},complete:function(){return l(!1)}})):k(!0)},m=function(){if(o.value.trim())return p.submit()},q.type="button",q.onclick=function(a){return a.altKey?m():f()},b(o,"keydown",function(a){if((a.ctrlKey||a.metaKey)&&a.which===13)return a.preventDefault(),a.stopPropagation(),f(),!1}),b(o,"blur",function(){o.value=o.value.trim()}),(t=function(){var a;a=!o.value.trim(),o._not_empty!==a&&k(a)})(),b(o,"input",t),b(o,"change",function(){o.value=o.value.trim(),t(),e()}),b=/Mac OS/i.test(navigator.userAgent)?"^/\u2318 + \u21b5":"ctrl+enter",q.insertAdjacentHTML("afterend",'<span class="fade"> '+b+" </span>")})()
