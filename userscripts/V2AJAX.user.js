// ==UserScript==
// @name V2AJAX (Ajax Submit in V2EX)
// @description using ajax to submit in v2ex.
// @version 0.2.2
// @auther yyfearth#gmail.com
// @include *://*.v2ex.com/t/*
// ==/UserScript==
(function(){var u,g,j,v,n,w,h,o,p,q,r,s,m,c,f,e,l,k,t,x,y=[].slice;j=function(a,b){null==b&&(b=document);return b.querySelector(a)};v=function(a,b){null==b&&(b=document);return[].slice.call(b.querySelectorAll(a))};g=function(a,b,c){return a.addEventListener(b,c,!1)};u=function(a){var b,c,e,f,g,h,j,d,i;i=null!=a?a:{};d=i.xhr;f=i.method;j=i.url;c=i.data;a=i.async;h=i.timeout;b=i.complete;g=i.success;e=i.error;null==d&&(d=new XMLHttpRequest);null==a&&(a=!0);d.open(f,j,a);/^post$/i.test(f)&&d.setRequestHeader("Content-type","application/x-www-form-urlencoded");h&&(d.timeout=h);d.onreadystatechange=function(){if(d.readyState===4){typeof b==="function"&&b(d);return d.status===200?typeof g==="function"?g(d.responseText,d):void 0:typeof e==="function"?e(d.status,d.responseText,d):void 0}};d.ontimeout=function(){return typeof e==="function"?e(d.status,"timeout",d):void 0};d.send(c);return d};h=function(){var a,b;a=arguments[0];b=2<=arguments.length?y.call(arguments,1):[];null==a&&(a=!0);console.error.apply(console,b);"submit"===a?f.submit():"reload"===a?location.reload():console.log("failed",a)};p=function(a){null==a&&(a=document);return(a=v("#Main>.box",a)[1])&&/\u611f\u8c22\u56de\u590d\u8005|\u76ee\u524d\u5c1a\u65e0\u56de\u590d|\d+\s*\u56de\u590d\s*\|\s*\u76f4\u5230/.test(a.innerText||a.textContent)?a:null};o=function(a){null==a&&(a=document);a=j("#Rightbar>.box",a);return j("#money",a)||j('[href="/notifications"]',a)?a:null};c=j("#reply_content");for(f=c.parentElement;"FORM"!==f.tagName;)if(f=f.parentElement,!f)return h("stop","cannot find submit form");e=j('input[type="submit"]');e.text=e.value;m=p(null);if(!m)return h("stop","cannot find replies box");(q=o(null))||h("continue","cannot find info box");k=f.action+"#content";l=localStorage[k]||"";!c.value&&l&&(c.value=l,console.log("load from store",k,l));n=function(){var a;a=c.value;if((l=localStorage[k])||a){localStorage[k]=a.trim();console.log("save to store",k,a)}};g(window,"unload",n);r=function(a){e.classList[a?"remove":"add"]("normal");return e.disabled=!!a};s=function(a){var b,f;if(a){f="...";a="remove";b=true}else{f="";a="add";b=false}e.value=e.text+f;e.classList[a]("normal");return e.disabled=c.disabled=b};x=function(a){var b;if(!(a=a.trim())){alert("ajax return empty result");h("reload","empty return html")}a=a.replace(/<script.*?<\/script>/ig,"");b=document.implementation.createHTMLDocument();b.documentElement.innerHTML=a;if(b.title&&document.title!==b.title)document.title=b.title;(a=p(b))||h("reload","cannot locate new replies");m.className=a.className;m.innerHTML=a.innerHTML;c.value="";c.focus();if(q)(b=o(b))?q.innerHTML=b.innerHTML:h("continue","cannot locate new info box")};e.type="button";e.onclick=w=function(){var a;console.log("ajax submit");if(a=c.value.trim()){a="content="+encodeURIComponent(a.replace(/\n/g,"\r\n"));s(true);u({url:f.action,method:f.method,data:a,timeout:5E3,success:x,error:function(a,c){return h("submit","ajax failed",a,c)},complete:function(){return s(false)}})}else r(true)};g(c,"keydown",function(a){if((a.ctrlKey||a.metaKey)&&a.which===13){a.preventDefault();a.stopPropagation();w();return false}});g(c,"blur",function(){c.value=c.value.trim()});(t=function(){var a;a=!c.value.trim();c._not_empty!==a&&r(a)})();g(c,"input",t);g(c,"change",function(){c.value=c.value.trim();t();n()});g=/Mac OS/i.test(navigator.userAgent)?"^/\u2318 + \u21b5":"ctrl+enter";e.insertAdjacentHTML("afterend",'<span class="fade"> '+g+" </span>")})()
