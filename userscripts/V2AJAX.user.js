// ==UserScript==
// @name V2AJAX (Ajax Submit in V2EX)
// @description using ajax to submit in v2ex.
// @version 0.2.3
// @auther yyfearth#gmail.com
// @include *://*.v2ex.com/t/*
// ==/UserScript==
(function(){var v,g,j,w,n,o,h,p,q,r,s,t,x,m,c,e,f,l,k,u,y,z=[].slice;j=function(a,b){null==b&&(b=document);return b.querySelector(a)};w=function(a,b){null==b&&(b=document);return[].slice.call(b.querySelectorAll(a))};g=function(a,b,c){return a.addEventListener(b,c,!1)};v=function(a){var b,c,f,e,g,h,j,d,i;i=null!=a?a:{};d=i.xhr;e=i.method;j=i.url;c=i.data;a=i.async;h=i.timeout;b=i.complete;g=i.success;f=i.error;null==d&&(d=new XMLHttpRequest);null==a&&(a=!0);d.open(e,j,a);/^post$/i.test(e)&&d.setRequestHeader("Content-type","application/x-www-form-urlencoded");h&&(d.timeout=h);d.onreadystatechange=function(){if(d.readyState===4){typeof b==="function"&&b(d);return d.status===200?typeof g==="function"?g(d.responseText,d):void 0:typeof f==="function"?f(d.status,d.responseText,d):void 0}};d.ontimeout=function(){return typeof f==="function"?f(d.status,"timeout",d):void 0};d.send(c);return d};h=function(){var a,b;a=arguments[0];b=2<=arguments.length?z.call(arguments,1):[];null==a&&(a=!0);console.error.apply(console,b);"submit"===a?e.submit():"reload"===a?location.reload():console.log("failed",a)};q=function(a){null==a&&(a=document);return(a=w("#Main>.box",a)[1])&&/\u611f\u8c22\u56de\u590d\u8005|\u76ee\u524d\u5c1a\u65e0\u56de\u590d|\d+\s*\u56de\u590d\s*\|\s*\u76f4\u5230/.test(a.innerText||a.textContent)?a:null};p=function(a){null==a&&(a=document);a=j("#Rightbar>.box",a);return j("#money",a)||j('[href="/notifications"]',a)?a:null};c=j("#reply_content");for(e=c.parentElement;"FORM"!==e.tagName;)if(e=e.parentElement,!e)return h("stop","cannot find submit form");f=j('input[type="submit"]');f.text=f.value;m=q(null);if(!m)return h("stop","cannot find replies box");(r=p(null))||h("continue","cannot find info box");k=e.action+"#content";l=localStorage[k]||"";!c.value&&l&&(c.value=l,console.log("load from store",k,l));n=function(){var a;a=c.value;if((l=localStorage[k])||a){localStorage[k]=a.trim();console.log("save to store",k,a)}};g(window,"unload",n);s=function(a){f.classList[a?"remove":"add"]("normal");return f.disabled=!!a};t=function(a){var b,e;if(a){e="...";a="remove";b=true}else{e="";a="add";b=false}f.value=f.text+e;f.classList[a]("normal");return f.disabled=c.disabled=b};y=function(a){var b;if(!(a=a.trim())){alert("ajax return empty result");h("reload","empty return html")}a=a.replace(/<script.*?<\/script>/ig,"");b=document.implementation.createHTMLDocument();b.documentElement.innerHTML=a;if(b.title&&document.title!==b.title)document.title=b.title;(a=q(b))||h("reload","cannot locate new replies");m.className=a.className;m.innerHTML=a.innerHTML;c.value="";c.focus();if(r)(b=p(b))?r.innerHTML=b.innerHTML:h("continue","cannot locate new info box")};o=function(){var a;console.log("ajax submit");if(a=c.value.trim()){a="content="+encodeURIComponent(a.replace(/\n/g,"\r\n"));t(true);v({url:e.action,method:e.method,data:a,timeout:5E3,success:y,error:function(a,c){return h("submit","ajax failed",a,c)},complete:function(){return t(false)}})}else s(true)};x=function(){if(c.value.trim())return e.submit()};f.type="button";f.onclick=function(a){return a.altKey?x():o()};g(c,"keydown",function(a){if((a.ctrlKey||a.metaKey)&&a.which===13){a.preventDefault();a.stopPropagation();o();return false}});g(c,"blur",function(){c.value=c.value.trim()});(u=function(){var a;a=!c.value.trim();c._not_empty!==a&&s(a)})();g(c,"input",u);g(c,"change",function(){c.value=c.value.trim();u();n()});g=/Mac OS/i.test(navigator.userAgent)?"^/\u2318 + \u21b5":"ctrl+enter";f.insertAdjacentHTML("afterend",'<span class="fade"> '+g+" </span>")})()
