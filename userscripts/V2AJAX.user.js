// ==UserScript==
// @name V2AJAX (Ajax Submit in V2EX)
// @description using ajax to submit in v2ex.
// @version 0.2.6.0
// @auther yyfearth#gmail.com
// @include *://v2ex.com/t/*
// @include *://*.v2ex.com/t/*
// ==/UserScript==

(function(){var o,i,z,h,A,p,B,q,g,r,m,s,t,u,v,w,C,n,c,d,f,l,k,x,y,D=[].slice;h=function(a,b){null==b&&(b=document);return b.querySelector(a)};A=function(a,b){null==b&&(b=document);return[].slice.call(b.querySelectorAll(a))};i=function(a,b,c){return a.addEventListener(b,c,!1)};o=function(a){var b,c,d,f,g,h,i,e,j;j=null!=a?a:{};e=j.xhr;f=j.method;i=j.url;c=j.data;a=j.async;h=j.timeout;b=j.complete;g=j.success;d=j.error;null==e&&(e=new XMLHttpRequest);f=(f||"GET").toUpperCase();e.open(f,i,null!=a?a:!0);/^post$/i.test(f)&&e.setRequestHeader("Content-type","application/x-www-form-urlencoded");h&&(e.timeout=h);e.onreadystatechange=function(){if(e.readyState===4){typeof b==="function"&&b(e);return e.status===200?typeof g==="function"?g(e.responseText,e):void 0:typeof d==="function"?d(e.status,e.responseText,e):void 0}};e.ontimeout=function(){return typeof d==="function"?d(e.status,"timeout",e):void 0};e.send(c);return e};z=function(a){var b;b=document.implementation.createHTMLDocument(document.title);b.documentElement.innerHTML=a;return b};g=function(){var a,b;a=arguments[0];b=2<=arguments.length?D.call(arguments,1):[];null==a&&(a=!0);console.error.apply(console,b);"submit"===a?d.submit():"reload"===a?location.reload():console.log("failed",a)};t=function(a){null==a&&(a=document);return(a=A("#Main>.box",a)[1])&&/\u611f\u8c22\u56de\u590d\u8005|\u76ee\u524d\u5c1a\u65e0\u56de\u590d|\d+\s*\u56de\u590d\s*\|\s*\u76f4\u5230/.test(a.textContent)?a:null};s=function(a){null==a&&(a=document);a=h("#Rightbar>.box",a);return h("#money",a)||h('[href="/notifications"]',a)?a:null};m=function(a,b){var c;null==a&&(a=document);c=h('#Main a[href*="favorite"]',a);return!c?null:b?c:c.parentElement};c=h("#reply_content");for(d=c.parentElement;"FORM"!==d.tagName;)if(d=d.parentElement,!d)return g("stop","cannot find submit form");f=h('input[type="submit"]');f.text=f.value;n=t(null);if(!n)return g("stop","cannot find replies box");(u=s(null))||g("continue","cannot find info box");(r=m(null))||g("continue","cannot find fav bar");k=d.action+"#content";l=localStorage[k]||"";!c.value&&l&&(c.value=l,console.log("load from store",k,l));p=function(){var a;a=c.value;if((l=localStorage[k])||a){localStorage[k]=a.trim();console.log("save to store",k,a)}};i(window,"unload",p);y=function(a){var b;if(a=a.trim()){a=z(a);if(a.title&&document.title!==a.title)document.title=a.title;(b=t(a))||g("reload","cannot locate new replies");n.className=b.className;n.innerHTML=b.innerHTML;c.value="";if(u)(b=s(a))?u.innerHTML=b.innerHTML:g("continue","cannot locate new info box");if(r)if(b=m(a)){r.innerHTML=b.innerHTML;B()}else g("continue","cannot locate new fav bar");b=h('input[name="once"]',d);a=h('form input[name="once"]',a);b.value=a.value}else{alert("ajax return empty result");g("reload","empty return html")}};(B=function(){var a,b;(b=m(null,true))||g("continue","cannot locate new fav bar");a=b.href;b.href="#fav";b.onclick=function(c){c.preventDefault();b.textContent=b.textContent+"...";b.onclick=function(){return false};o({url:a,method:"GET",success:y,error:function(a,b){return console.error("fav failed",a,b)}});return false};console.log("fav ajax enabled")})();v=function(a){f.classList[a?"remove":"add"]("normal");return f.disabled=!!a};w=function(a){var b,d;if(a){d="...";a="remove";b=true}else{d="";a="add";b=false}f.value=f.text+d;f.classList[a]("normal");return f.disabled=c.disabled=b};q=function(){var a,b;console.log("ajax submit");if(a=c.value.trim()){b=h('input[name="once"]',d);a="once="+b.value+"&content="+encodeURIComponent(a.replace(/\n/g,"\r\n"));w(true);o({url:d.action,method:d.method,data:a,timeout:5E3,success:y,error:function(a,b){return g("submit","ajax failed",a,b)},complete:function(){return w(false)}})}else v(true)};C=function(){if(c.value.trim())return d.submit()};f.type="button";f.onclick=function(a){return a.altKey?C():q()};i(c,"keydown",function(a){if((a.ctrlKey||a.metaKey)&&a.which===13){a.preventDefault();a.stopPropagation();q();return false}});i(c,"blur",function(){c.value=c.value.trim()});(x=function(){var a;a=!c.value.trim();c._not_empty!==a&&v(a)})();i(c,"input",x);i(c,"change",function(){c.value=c.value.trim();x();p()});i=/Mac OS/i.test(navigator.userAgent)?"^/\u2318 + \u21b5":"ctrl+enter";f.insertAdjacentHTML("afterend",'<span class="fade"> '+i+" </span>")})();
